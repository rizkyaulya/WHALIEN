<!--#include file="/parts/head.html" -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 id="title" data-navbaractive="navdashboard" class="h2">Dashboard</h1>
</div>

<h3 id="h-miners" class="h-selector">Running Miners on <span class="workername"></span> <a href="#" id="pauseminers" class="btn btn-primary">Pause / Restart</a> <a href="#" id="lockminers" class="btn btn-primary">Lock / Unlock</a></h3>
<table id="miners" class="table mb-4"
       data-toggle="table"
       data-url="/runningminers"
       data-response-handler="formatRunningMiners"
       data-sort-order="desc"
       data-sort-name="Profit"
       data-cache="false"
       data-icons-prefix="fa"
       data-icons="icons"
       data-detail-view="true"
       data-detail-formatter="detailFormatter">
    <thead>
        <tr>
            <th data-field="Name" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Name</th>
            <th data-field="Pool" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Pool</th>
            <th data-field="tCoin" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Coin</th>
            <th data-field="Currency" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Currency</th>
            <th data-field="tDevices" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Devices</th>
            <th data-field="tOC" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">OC</th>
            <th data-field="Profit" data-align="right" data-sortable="true" data-formatter="formatPricesBTC">Profit</th>
            <th data-field="tPowerDraw" data-align="right" data-sortable="true">Power</th>
            <th data-field="tPrimaryAlgorithm" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Algo</th>
            <th data-field="tPrimaryHashRateLive" data-sortable="true" data-formatter="formatHashRateValue">Speed</th>
            <th data-field="tPrimaryHashRate" data-sortable="true" data-formatter="formatHashRateValue" data-filter-stric-search="true">Benched</th>
            <th data-field="tActive" data-align="right" data-sortable="true">Active</th>
            <th data-field="tDonator" data-sortable="true">Mines</th>
        </tr>
    </thead>
</table>

<div id="devicestatus">
    <h3 class="mt-4 h-selector" id="h-devices">Device Status</h3>    
    <table id="devices" class="table"
           data-toggle="table"
           data-url="/devices"
           data-response-handler="formatDevices"
           data-cache="false"
           data-icons-prefix="fa"
           data-icons="icons"
           data-detail-view="true"
           data-detail-formatter="detailFormatter">
        <thead>
            <tr>
                <th data-field="Name" data-sortable="true" data-title-tooltip="The name, Rainbowminer uses to identify this device">Name</th>
                <th data-field="Vendor" data-sortable="true" data-title-tooltip="Vendor of the device">Vendor</th>
                <th data-field="Model" data-sortable="true" data-title-tooltip="Modelname of the device">Model</th>
                <th data-field="tMemory" data-sortable="true" data-title-tooltip="Memory on the device in GB">Mem</th>
                <th data-field="tTemperature" data-sortable="true" data-title-tooltip="Current temperature in °C">°C</th>
                <th data-field="tTemperatureMax" data-sortable="true" data-title-tooltip="Maximum temperature in °C">max °C</th>
                <th data-field="tFanSpeed" data-sortable="true" data-title-tooltip="Current fan speed in %">Fan</th>
                <th data-field="tPowerDraw" data-sortable="true" data-title-tooltip="Current power draw in watt">Power</th>
                <th data-field="tClock" data-sortable="true" data-title-tooltip="Current GPU clock in MHz">Clock</th>
                <th data-field="tClockMem" data-sortable="true" data-title-tooltip="Current memory clock in MHz">Memclk</th>
                <th data-field="tPowerLimitPercent" data-sortable="true" data-title-tooltip="Current power limit in %">PL</th>
            </tr>
        </thead>
    </table>
</div>

<div id="remoteworkers">
    <h3 class="mt-4 h-selector" id="h-remoteminers">Remote Workers</h3>
    <table id="remoteminers" class="table mb-4"
           data-toggle="table"
           data-url="/remoteminers"
           data-response-handler="formatRemoteMiners"
           data-sort-order="desc"
           data-sort-name="Profit"
           data-cache="false"
           data-icons-prefix="fa"
           data-icons="icons"
           data-detail-view="true"
           data-detail-formatter="detailFormatterRemoteMiners"
           data-row-style="colorStatus">
        <thead>
            <tr>
                <th data-field="worker" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Name</th>
                <th data-field="status" data-sortable="true" data-filter-control="select" data-filter-strict-search="true">Status</th>
                <th data-field="tlastseen" data-sortable="true">Last seen</th>
                <th data-field="tuptime" data-sortable="true">Uptime</th>
                <th data-field="tversion" data-sortable="true">Version</th>
                <th data-field="profit" data-align="right" data-sortable="true" data-formatter="formatPricesBTC">Profit</th>
                <th data-field="tpowerdraw" data-align="right" data-sortable="true">Power</th>
            </tr>
        </thead>
    </table>
</div>

<h3 class="mt-4 h-selector" id="h-balanceboxes">Balances <a href="#" id="updatebalance" class="btn btn-primary">Update</a></h3>
<div id="balanceboxes" class="card-deck"></div>

<!-- End of page scripts -->
<script id="poolbalance_template" type="text/x-handlebars-template">
    <div class="mb-2 card {{#if total}}text-white bg-primary{{else if dark}}text-light bg-dark{{else}}text-dark bg-white{{/if}}" style="min-width: {{#if total}}200px{{else}}200px{{/if}}">
        <div class="card-header text-center">
            <h5>{{name}}</h5>
        </div>
        <div class="card-body text-center">
            <p class="card-text currencies">
                {{#each balances}}
                <span class="currencyname font-weight-bold">{{@key}}:</span> <span>{{this}}</span><br />
                {{/each}}
            </p>
        </div>
        <div class="card-footer text-center">
            <p class="card-text">
                <span class="currencyname font-weight-bold">Avg.Earned:</span> <span>{{earnings}}</span>
            </p>
        </div>
    </div>
</script>

<script type="text/javascript">
    $(function () {
        var template = Handlebars.compile($("#poolbalance_template").html());
        $("#pauseminers").click(function (event) {
            event.stopPropagation()
            $.ajax({
                url: '/pause', success: function (result) {
                    $("#pauseminers").html(result ? "Restart" : "Pause");
                }
            })
        });

        $("#lockminers").click(function (event) {
            event.stopPropagation()
            $.ajax({
                url: '/lockminers', success: function (result) {
                    $("#lockminers").html(result ? "Unlock" : "Lock");
                }
            })
        });

        $("#updatebalance").click(function (event) {
            event.stopPropagation()
            $.ajax({
                url: '/updatebalance', success: function (result) {
                    $('.modal-body').text('The balances will be updated as soon as possible');
                    $('.modal-title').text('Update Balance');
                    $('#myModal').modal({ show: true });
                }
            })
        });

        $('.h-selector').each(function () {
            var sto = window.localStorage.getItem($(this).attr("id"));
            if (sto && sto == "hide") {
                $("#" + ($(this).attr("id").replace(/h-/, ""))).hide();
            }
        });

        $('.h-selector').click(function () {
            var blkname = $(this).attr("id").replace(/h-/,"");
            var visible = $("#" + blkname).is(":visible");
            if (visible) { $("#" + blkname).hide(); } else { $("#" + blkname).show(); }

            window.localStorage.setItem($(this).attr("id"), visible ? "hide" : "show");
        });

        (function updatePoolBalances() {
            $.ajax({
                url: '/balances?add_total=1&add_btc=1', success: function (result) {
                    //console.log(result);
                    $("#balanceboxes").empty();
                    var boxes = [], boxes_ix = {}, total_earnings = 0;
                    $.each(result, function (index, item) {
                        var properties = Object.keys(item);
                        var currencies = properties.filter((properties) => properties.startsWith("Value in "));
                        var balance = properties.filter((properties) => properties.startsWith("Balance "));
                        var maincur = [];

                        if (boxes_ix[item.Name] === undefined) {
                            boxes_ix[item.Name] = boxes.length;
                            if (item.Name == "*Total*") {
                                boxes.push({ name: "Total Balance From All Pools", balances: {}, digits: {}, total: true, dark: theme=="dark" });
                            } else {
                                boxes.push({ name: item.Name, balances: {}, digits: {}, earnings: 0, dark: theme == "dark" });
                            }
                        }

                        if (item.Name != "*Total*") {
                            var avg_earnings = parseFloat(item.Earnings_Avg_BTC);
                            total_earnings += avg_earnings;
                            boxes[boxes_ix[item.Name]]["earnings"] += avg_earnings;
                        }

                        $.each(currencies, function (cindex, currency) {
                            var name = currency.replace("Value in ", "");
                            item[currency] = item[currency].replace(tDecimalSeparator, "").replace(nDecimalSeparator, ".")
                            var csplit = item[currency].split(".");
                            var digits = boxes[boxes_ix[item.Name]]["digits"][name] = item[currency] === "-" ? -1 : (csplit.length < 2 ? 0 : csplit[1].length);

                            if (digits != -1) { item[currency] = parseFloat(item[currency]) }
                            if (boxes[boxes_ix[item.Name]]["balances"][name] === undefined) { boxes[boxes_ix[item.Name]]["balances"][name] = item[currency]; maincur.push(name); }
                            else if (digits != -1) {
                                if (boxes[boxes_ix[item.Name]]["balances"][name] === "-") boxes[boxes_ix[item.Name]]["balances"][name] = 0.0;
                                boxes[boxes_ix[item.Name]]["balances"][name] += parseFloat(item[currency]);
                            }
                        });
                        $.each(balance, function (cindex, currency) {
                            var name = currency.replace("Balance (", "").replace(")", "");
                            if ($.inArray(name,maincur)===-1) {
                                item[currency] = item[currency].replace(tDecimalSeparator, "").replace(nDecimalSeparator, ".")
                                var csplit = item[currency].split(".");
                                var digits = boxes[boxes_ix[item.Name]]["digits"][name] = item[currency] === "-" ? -1 : (csplit.length < 2 ? 0 : csplit[1].length);
                                if (digits != -1) { item[currency] = parseFloat(item[currency]) }
                                if (boxes[boxes_ix[item.Name]]["balances"][name] === undefined) { boxes[boxes_ix[item.Name]]["balances"][name] = item[currency]; }
                                else if (digits != -1) {
                                    if (boxes[boxes_ix[item.Name]]["balances"][name] === "-") boxes[boxes_ix[item.Name]]["balances"][name] = 0.0;
                                    boxes[boxes_ix[item.Name]]["balances"][name] += parseFloat(item[currency]);
                                }
                            }
                        });
                    });
                    $.each(boxes, function (index, item) {
                        $.each(item["balances"], function (bindex, bitem) { if (item["digits"][bindex] != -1) item["balances"][bindex] = bindex == "BTC" ? formatPricesBTC(bitem).replace('&nbsp;', ' ') : bitem.toFixed(item["digits"][bindex]); });
                        item.earnings = formatPricesBTC(item.total ? total_earnings : item.earnings).replace('&nbsp;', ' ');
                        $("#balanceboxes").append(template(item));
                    });
                    window.setTimeout(updatePoolBalances, 60000);
                }
            });
        })();
        (function updateStatus() {
            $.ajax({
                url: '/status', success: function (result) {
                    $("#pauseminers").html(result.Pause ? "Restart" : "Pause");
                    $("#lockminers").html(result.LockMiners.Locked ? "Unlock" : "Lock");
                    if (result.IsExclusiveRun || result.IsDonationRun) {
                        $("#lockminers").hide()
                    } else {
                        $("#lockminers").show()
                    }
                    window.setTimeout(updateStatus, 10000);
                }
            });
        })();
        function refreshTable() {
            $("table#miners").bootstrapTable("refresh", { silent: true });
            $("table#devices").bootstrapTable("refresh", { silent: true });
            window.setTimeout(refreshTable, 10000);
        }
        window.setTimeout(refreshTable, 10000);
        function refreshTableRemoteMiners() {
            $("table#remoteminers").bootstrapTable("refresh", { silent: true });
            window.setTimeout(refreshTableRemoteMiners, 60000);
        }
        window.setTimeout(refreshTableRemoteMiners, 60000);

    });

  function formatRunningMiners(data) {
      // This function can alter the returned data before building the table, formatting it in a way
      // that is easier to display and manipulate in a table
      $.each(data, function (index, item) {
          // Format the type(s)
          //console.log(data);
          //console.log(item);
          item.tDevices = item.DeviceModel.toString();
          item.Name = item.Name.split(/\-/)[0];
          if (item.IsLocked) {item.Name += " (locked!)"}

          // Format the algorithms and hashrates

          // Algorithm is always an array, sometimes has 2 elements
          item.tPrimaryAlgorithm = formatAlgorithm(item.Algorithm[0]);
          try { item.tSecondaryAlgorithm = formatAlgorithm(item.Algorithm[1]); } catch (error) { /* ignore */ }

          // Speed is an array if there are multiple algorithms, or a single number otherwise
          if (Array.isArray(item.Speed)) {
              item.tPrimaryHashRate = item.Speed[0];
              item.tSecondaryHashRate = item.Speed[1];
          } else {
              item.tPrimaryHashRate = item.Speed;
          }

          if (Array.isArray(item.Speed_Live)) {
              item.tPrimaryHashRateLive = item.Speed_Live[0];
              item.tSecondaryHashRateLive = item.Speed_Live[1];
          } else {
              item.tPrimaryHashRateLive = item.Speed_Live;
          }
          item.tPowerDraw = Math.round(parseFloat(item.PowerDraw)) + ' W';

          item.tDonator = item.Donator ? "for dev" : "for you";

          item.tCoin = typeof item.CoinSymbol !== "undefined" && item.CoinSymbol !== "" ? item.CoinSymbol : (typeof item.CoinName !== "undefined" && item.CoinName !== "" ? item.CoinName : '-')

          // Format the Profile(s)
          var tOC = new Array();
          if (globalconfig.OCmode == "msia") {
              if (item.MSIAprofile) { tOC.push("MSIA" + item.MSIAprofile); }
          } else if (globalconfig.OCmode == "ocp") {
              var devices = item.DeviceModel.toString().split(/\-/);
              var cnt = devices.length
              $.each(devices, function (ix, dev) {
                  if (dev != "CPU" && item.OCprofile[dev]) {
                      if (cnt == 1) { tOC.push(item.OCprofile[dev]); }
                      else {
                          tOC.push(dev + "=" + item.OCprofile[dev]);
                      }
                  }
              });
          }
          if (!tOC.length) { tOC.push("-"); }
          item.tOC = tOC.join('<br />');

          item.tActive = (item.RunningTime.Days ? item.RunningTime.Days + '.' : '') + (item.RunningTime.Hours < 10 ? '0' : '') + item.RunningTime.Hours + ':' + (item.RunningTime.Minutes < 10 ? '0' : '') + item.RunningTime.Minutes + ':' + (item.RunningTime.Seconds < 10 ? '0' : '') + item.RunningTime.Seconds
      });
      return data;
  }

  function formatRemoteMiners(data) {
      // This function can alter the returned data before building the table, formatting it in a way
      // that is easier to display and manipulate in a table
      if (data && data.length) $("div#remoteworkers").show()
      else $("div#remoteworkers").hide()
      now = new Date();
      $.each(data, function (index, item) {
          // Format the type(s)
          //console.log(data);
          //console.log(item);                   
          item.tlastseen = timeSince(new Date(item.lastseen * 1000));
          item.tuptime = item.uptime && parseInt(item.uptime) > 0 ? formatUptime(item.uptime) : '-';
          var vb = item.version.split(" ");
          item.tversion = vb.length > 1 ? vb[1] : item.version

          if (item.status == "Running") {
              if (!item.online || ((now - new Date(item.lastseen * 1000)) / 1000) > 10 * 60) { item.status = "Offline" }
              else {
                  $.each(item.data, function (dix, ditem) {
                      if (ditem.Benchmarking) { item.status = "Benchmarking" }
                  })
              }
          }

          item.tpowerdraw = Math.round(parseFloat(item.powerdraw)) + ' W';
      });
      return data;
  }

  function colorStatus(row, index) {
      return { classes: row.status };
  }

  function detailFormatterRemoteMiners(index, row) {
      var html = [];
      html.push("<strong>Running Miners</strong>");
      html.push("<table class='table table-responsive table-details"+(theme=="dark"? " table-dark":'')+"'>");
      html.push("<thead><tr><th><div class='th-inner'>Name</div></th><th><div class='th-inner'>Algorithm</div></th><th><div class='th-inner'>Pool</div></th><th><div class='th-inner'>Coin</div></th><th><div class='th-inner'>Currency</div></th><th><div class='th-inner'>Device</div></th><th><div class='th-inner'>Profit</div></th><th><div class='th-inner'>Speed</div></th><th><div class='th-inner'>Benched</div></th><th><div class='th-inner'>Power</div></th><th><div class='th-inner'>Active</div></th><th><div class='th-inner'>Mines</div></th></tr></thead>");
      jQuery.each(row.data, function (key, value) {
          html.push('<tr>');
          html.push('<td>' + value.Name + '</td>');
          html.push('<td>' + formatAlgorithm(value.Algorithm) + '</td>');
          html.push('<td>' + value.Pool + '</td>');
          html.push('<td>' + (typeof value.CoinSymbol !== "undefined" && value.CoinSymbol != "" && value.Pool != "MiningRigRentals" ? value.CoinSymbol : (typeof value.CoinName !== "undefined" && value.CoinName != "" ? value.CoinName : '-')) + '</td>');
          html.push('<td>' + value.Currency + '</td>');
          html.push('<td>' + value.Type + '</td>');
          html.push('<td>' + formatPricesBTC(value.Profit) + '</td>');
          html.push('<td>' + formatHashRate(value.CurrentSpeed) + '</td>');
          html.push('<td>' + formatHashRate(value.EstimatedSpeed) + '</td>');
          html.push('<td>' + Math.round(parseFloat(value.PowerDraw)) + ' W</td>');
          html.push('<td>' + value.Active + '</td>');
          html.push('<td>' + (value.Donator? "for dev":"for you") + '</td>');
          html.push('</tr>');
      });
      html.push("</table>");
      return html.join('');
  }

  function formatDevices(data) {
      // This function can alter the returned data before building the table, formatting it in a way
      // that is easier to display and manipulate in a table
      $.each(data, function (index, item) {
          // Format the device(s)
          if (item.OpenCL) {
              item.tMemory = formatBytes(item.OpenCL.GlobalMemSize)
              item.tDriverVersion = item.OpenCL.DriverVersion
              item.tCores = item.OpenCL.MaxComputeUnits
          } else {
              item.tMemory = formatBytes(item.Data.CacheL3 * 1024 * 1024)
              item.tDriverVersion = "N/A"
              item.tCores = item.Data.Cores ? item.Data.Cores + "/" + item.Data.Threads : "N/A"
          }

          item.tPowerDraw = typeof (item.Data.PowerDraw) !== "undefined" ? Math.round(parseFloat(item.Data.PowerDraw)) + ' W' : "N/A"
          item.tFanSpeed = typeof (item.Data.FanSpeed) !== "undefined" ? item.Data.FanSpeed + ' %' : "N/A"
          item.tClock = typeof (item.Data.Clock) !== "undefined" ? item.Data.Clock + ' MHz' : "N/A"
          item.tClockMem = typeof (item.Data.ClockMem) !== "undefined" ? item.Data.ClockMem + ' MHz' : "N/A"
          item.tPowerLimitPercent = typeof (item.Data.PowerLimitPercent) !== "undefined" ? item.Data.PowerLimitPercent + ' %' : "N/A"
          item.tTemperature = typeof (item.Data.Temperature) !== "undefined" && item.Data.Temperature ? item.Data.Temperature + ' °C' : "N/A"
          item.tTemperatureMax = typeof (item.DataMax.Temperature) !== "undefined" && item.Data.Temperature ? item.DataMax.Temperature + ' °C' : "N/A"
          item.tUtilization = typeof (item.Data.Utilization) !== "undefined" ? item.Data.Utilization + ' %' : "N/A"
      });
      return data;
  }
</script>
<!--#include file="/parts/foot.html" -->